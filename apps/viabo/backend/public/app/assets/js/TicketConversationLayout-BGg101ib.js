import{T as R,g as V,b as v,L as A,_ as I,j as b}from"./index-DkbAsBWZ.js";import{c as Q,f as K,bd as C,U as w,r as S,i as p,e8 as j,S as D,y as z,P as E}from"./vendor-5lkxkETF.js";import{u as U}from"./formik.esm-CTTSENmf.js";import{c as $,a as B,d as G}from"./index.esm-gIIytEq8.js";import{i as M}from"./matchTypes-mENztEWg.js";import{T as g}from"./tickets-support-list-keys-S53qn0fN.js";import{a as Y}from"./SupportIncidences--7t481Hh.js";import"./TextMaxLine-B63DtfW-.js";import"./formatTime-jCgU2sMR.js";import"./MaterialDataTable-Dl1JQ_sM.js";import"./useMaterialTable-8QQmzXWd.js";import"./HeaderPage-Bqn_U64p.js";import"./fade-CViozI82.js";import"./transition-anLY3gj9.js";import"./UploadSingleFile-ByYCreVQ.js";import"./formatNumber-dGNhWwxT.js";const H=(i,a,n)=>{const{message:r,attachments:e}=a,s=new FormData;s.append("message",r),s.append("ticketId",i),e==null||e.forEach(m=>{s.append("files[]",m)});const o=new Date().toLocaleString(),l=window.crypto||window.msCrypto,u=new Uint32Array(1),c={id:l.getRandomValues(u)[0],name:n==null?void 0:n.name,initials:R((n==null?void 0:n.name)||""),message:r,createDate:{fToNow:"justo ahora",original:o},my:!0,attachment:e||[],avatar:r!=null&&r.photo&&(r==null?void 0:r.photo)!==""?r==null?void 0:r.photo:"/",isSent:!1};return{data:s,ticketId:i,optimistic:c}},J=(i={})=>{const a=Q(),n=K({mutationFn:Y,onMutate:async e=>{const s=[g.TICKET_CONVERSATION,e==null?void 0:e.ticketId];await a.cancelQueries({queryKey:s});const o=a.getQueryData(s);return a.setQueryData(s,l=>{const u=l.pages.flat().map(t=>{var T,_;return{...t,results:{participants:((T=t==null?void 0:t.results)==null?void 0:T.participants)||[],messages:[e==null?void 0:e.optimistic,...(_=t==null?void 0:t.results)==null?void 0:_.messages]}}}),c=C.chunk(u,10);return{pageParams:[void 0,...c.slice(0,-1).map(t=>t.at(-1).createdAt)],pages:c.flat()}}),{previousMessages:o}},onError:(e,s,o)=>{a.setQueryData([g.TICKET_CONVERSATION,s==null?void 0:s.ticketId],o.previousMessages)},onSettled:(e,s,o,l)=>{a.invalidateQueries({queryKey:[g.TICKET_CONVERSATION,o==null?void 0:o.ticketId]})},...i});return{...n,mutate:async(e,s)=>{const{onSuccess:o,onError:l,...u}=s;try{await w.promise(n.mutateAsync(e,u),{pending:"Agregando Mensaje al Ticket...",success:{render({data:c}){return M(o)&&o(c),"Se envió el mensaje con éxito"}}}),a.invalidateQueries([g.ASSIGNED_LIST]),a.invalidateQueries([g.GENERATED_LIST])}catch(c){const m=V(c,"No se puede realizar esta operación en este momento. Intente nuevamente o reporte a sistemas");M(l)&&l(m),w.error(m,{type:v(c)})}}}},W=A(S.lazy(()=>I(()=>import("./TicketMessages-F8lSYUiK.js"),__vite__mapDeps([0,1,2,3,4])))),X=A(S.lazy(()=>I(()=>import("./TicketAddAttachmentFiles-s-HOYPQW.js"),__vite__mapDeps([5,1,2,3,4])))),Z=A(S.lazy(()=>I(()=>import("./TicketMessageInput-2lIunjBw.js"),__vite__mapDeps([6,1,7])))),k=({ticket:i,queryTicketConversation:a})=>{var x;const{mutate:n,isLoading:r}=J(),e=b(),[s,o]=S.useState(!1),l=$().shape({message:B().required("El mensaje es requerido"),attachments:G()}),u=U({validateOnChange:!1,enableReinitialize:!1,initialValues:{message:"",attachments:[]},validationSchema:l,onSubmit:(h,{setSubmitting:d,resetForm:f})=>{const O=H(i==null?void 0:i.id,h,e);n(O,{onSuccess:()=>{d(!1),f()},onError:()=>{d(!1)}})}}),{handleSubmit:c,isSubmitting:m,values:t,setFieldValue:T,validateForm:_}=u,y=m||r,F=h=>{const d=Array.from(h.target.files);T("attachments",[...d,...t.attachments])},L=h=>{var d;T("attachments",(d=t==null?void 0:t.attachments)==null?void 0:d.filter(f=>f!==h))},N=async h=>{var f;h.preventDefault(),o(!0);const d=await _();d&&((f=Object.keys(d))==null?void 0:f.length)>0&&(window.scrollTo(0,0),w.warn("Verifique todos los campos obligatorios")),c()},P=S.useMemo(()=>t==null?void 0:t.attachments,[t==null?void 0:t.attachments]);return p.jsxs(p.Fragment,{children:[(a==null?void 0:a.isFetching)&&p.jsx(j,{}),p.jsx(D,{sx:{overflow:"hidden"},children:p.jsx(W,{queryTicketConversation:a,scroll:s,setScroll:o})}),p.jsxs(D,{flex:1,justifyContent:"flex-end",children:[(a==null?void 0:a.isFetching)&&p.jsx(j,{}),p.jsx(z,{}),!y&&p.jsx(X,{files:P,isLoading:y,handleRemoveFile:L}),((x=i==null?void 0:i.status)==null?void 0:x.id)!=="3"&&p.jsx(Z,{formik:u,isLoading:y,handleAddMessage:N,handleFileChange:F})]})]})};k.propTypes={queryTicketConversation:E.shape({isFetching:E.any}),ticket:E.shape({id:E.any,status:E.shape({id:E.string})})};export{k as default};
function __vite__mapDeps(indexes) {
  if (!__vite__mapDeps.viteFileDeps) {
    __vite__mapDeps.viteFileDeps = ["assets/js/TicketMessages-F8lSYUiK.js","assets/js/vendor-5lkxkETF.js","assets/js/index-DkbAsBWZ.js","assets/css/build-Bl0dWaDY.css","assets/js/getFileFormat-1mdVNW85.js","assets/js/TicketAddAttachmentFiles-s-HOYPQW.js","assets/js/TicketMessageInput-2lIunjBw.js","assets/js/formik.esm-CTTSENmf.js"]
  }
  return indexes.map((i) => __vite__mapDeps.viteFileDeps[i])
}
//# sourceMappingURL=TicketConversationLayout-BGg101ib.js.map
